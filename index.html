<!DOCTYPE html>
<html>
   <head>
      <title>Storage Access API Test</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
   </head>
   <body>
      <div id="main">
        <p>Determining storage access API status</p>
      </div>
      <script>
        function doThingsWithCookies() {
            document.cookie = "foo=bar"; // set a cookie
            // replace the content of the main div with a message
            $("#main").html("<p>We have cookie access!</p>");
            $("#main").append("<p>Cookie value: " + document.cookie + "</p>");
        }

        async function handleCookieAccess() {
            console.log('tick1');    

            if (!document.hasStorageAccess) {
                console.log('tick2');    
                // This browser doesn't support the Storage Access API
                // so let's just hope we have access!
                doThingsWithCookies();
            } else {
                console.log('tick3');    
                const hasAccess = await document.hasStorageAccess();
                if (hasAccess) {
                    console.log('tick4');    
                    // We have access to third-party cookies, so let's go
                    doThingsWithCookies();
                } else {
                    console.log('tick5');    
                    // Check whether third-party cookie access has been granted
                    // to another same-site embed
                    try {
                        const permission = await navigator.permissions.query({
                            name: "storage-access",
                        });
                        console.log('tick6');    

                        if (permission.state === "granted") {
                            console.log('tick7');    
                            // If so, you can just call requestStorageAccess() without a user interaction,
                            // and it will resolve automatically.
                            const handle = await document.requestStorageAccess({
                                cookies: true,
                            });
                            doThingsWithCookies();
                        } else if (permission.state === "prompt") {
                            console.log('tick8');    
                            // Need to call requestStorageAccess() after a user interaction
                            btn.addEventListener("click", async () => {
                                try {
                                const handle = await document.requestStorageAccess({
                                    cookies: true,
                                });
                                doThingsWithCookies();
                                } catch (err) {
                                // If there is an error obtaining storage access.
                                console.error(`Error obtaining storage access: ${err}.
                                                Please sign in.`);
                                }
                            });
                        } else if (permission.state === "denied") {
                            // User has denied third-party cookie access, so we'll
                            // need to do something else
                            console.log('permission.state === "denied"');    
                        }
                    } catch (error) {
                        console.log(`Could not access permission state. Error: ${error}`);
                        doThingsWithCookies(); // Again, we'll have to hope we have access!
                    }
                }
            }
        }
        console.log('tick0');    

        $(document).ready(function() {
            console.log('tick0.1');    
            handleCookieAccess();
        });
      </script>
   </body>
</html>
