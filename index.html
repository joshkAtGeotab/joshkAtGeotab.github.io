<!DOCTYPE html>
<html>
   <head>
      <title>Storage Access API Test</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
   </head>
   <body>
      <div id="main">
        <p>Determining storage access API status</p>
      </div>
      <script>
        function doThingsWithCookies() {
            document.cookie = "foo=bar"; // set a cookie
            $(document).ready(function() {
                // replace the content of the main div with a message
                $("main").html("<p>We have cookie access!</p>");
                $("main").append("<p>Cookie value: " + document.cookie + "</p>");
            });
        }

        function doThingsWithLocalStorage(handle) {
            handle.localStorage.setItem("foo", "bar"); // set a local storage key
        }

        async function handleCookieAccess() {
            if (!document.hasStorageAccess) {
                // This browser doesn't support the Storage Access API
                // so let's just hope we have access!
                doThingsWithCookies();
            } else {
                const hasAccess = await document.hasStorageAccess();
                if (hasAccess) {
                    // We have access to third-party cookies, so let's go
                    doThingsWithCookies();
                    // If we want to modify unpartitioned state, we need to request a handle.
                    const handle = await document.requestStorageAccess({
                        localStorage: true,
                    });
                    doThingsWithLocalStorage(handle);
                } else {
                    // Check whether third-party cookie access has been granted
                    // to another same-site embed
                    try {
                        const permission = await navigator.permissions.query({
                            name: "storage-access",
                        });

                        if (permission.state === "granted") {
                            // If so, you can just call requestStorageAccess() without a user interaction,
                            // and it will resolve automatically.
                            const handle = await document.requestStorageAccess({
                                cookies: true,
                                localStorage: true,
                            });
                            doThingsWithLocalStorage(handle);
                            doThingsWithCookies();
                        } else if (permission.state === "prompt") {
                            // Need to call requestStorageAccess() after a user interaction
                            btn.addEventListener("click", async () => {
                                try {
                                const handle = await document.requestStorageAccess({
                                    cookies: true,
                                    localStorage: true,
                                });
                                doThingsWithLocalStorage(handle);
                                doThingsWithCookies();
                                } catch (err) {
                                // If there is an error obtaining storage access.
                                console.error(`Error obtaining storage access: ${err}.
                                                Please sign in.`);
                                }
                            });
                        } else if (permission.state === "denied") {
                            // User has denied third-party cookie access, so we'll
                            // need to do something else
                            console.log('permission.state === "denied"');    
                        }
                    } catch (error) {
                        console.log(`Could not access permission state. Error: ${error}`);
                        doThingsWithCookies(); // Again, we'll have to hope we have access!
                    }
                }
            }
        }
        $(document).ready(function() {
            handleCookieAccess();
        });
      </script>
   </body>
</html>
